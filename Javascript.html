<script>
function addCell(value, newCell, newRow)
{
  newCell = newRow.insertCell();
  var newText = document.createTextNode(value);
  newCell.appendChild(newText);
  return newCell;
}
function calculateMaxLoss(shortStrike, longStrike, credit, numberOfContracts)
{
  var spreadWidth = Math.abs(shortStrike-longStrike);
  var maxLossUnit = spreadWidth-credit;
  var maxLossTotal = maxLossUnit*numberOfContracts;
  return maxLossTotal.toFixed(2);
}

function addCalculations(range, newCell, newRow, i)
{
  var midCell = addCell('', newCell, newRow);
  var lastCell = addCell('', newCell, newRow);
  var pandLCell = addCell('', newCell, newRow);
  var maxLossCell = addCell(maxLoss(range, i), newCell, newRow);
  getAsynchSpreadPrice(range[i][0], range[i][1], range[i][2], range[i][3], range[i][4], range[i+1][3], range[i+1][4], range[i][6], midCell, lastCell, pandLCell);
}
function addHeader(tableName, headerName)
{
  var tr, th;
  tr = document.getElementById(tableName).tHead.children[0],
  th = document.createElement('th');
  th.innerHTML = headerName;
  tr.appendChild(th);
}
function checkClosingData(i)
{
  if (i===7||i===9) return true;
  return false;
}
function findOpenTrades(range)
{
  var tab = document.getElementById("theTable");
  var newRow, newCell;
  var header = tab.createTHead();

  for (var i = 1; i < range.length; i++) {
    if(range[i][3] == "") break;
    if(range[i][9] == "")
    {
      newRow = tab.insertRow();
      for (var j = 0; j < range[i].length; j++) {
        if(checkClosingData(j)) continue;
        addCell(range[i][j], newCell, newRow);
      }        
      addCalculations(range, newCell, newRow, i);
      if(range[i][1] == "IB" ||range[i][1] == "IC")
      {
        i++;
        newRow = tab.insertRow();
        for (var j = 0; j < range[i].length; j++) {
          if(checkClosingData(j)) continue;
          addCell(range[i][j], newCell, newRow);
        }
      }
    }
  }

  newRow = header.insertRow();     
  for (var j = 0; j < range[0].length; j++) { 
      if(checkClosingData(j)) continue;
      addHeader("theTable", range[0][j]); 
  }
  addHeader("theTable", "Mid Price");
  addHeader("theTable", "Last Price");
  addHeader("theTable", "P/L");
  addHeader("theTable", "Max Loss");
  set2018Trades(range);
}
function calculateDaysInTrade(openDate, closeDate)
{
  let split = openDate.split('/');
  openDate = new Date(parseInt(split[2]), parseInt(split[0])-1, parseInt(split[1]));
  split = closeDate.split('/');
  closeDate = new Date(parseInt(split[2]), parseInt(split[0])-1, parseInt(split[1]));
  var timeDiff = Math.abs(closeDate.getTime() - openDate.getTime());
  var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24)); 
  return diffDays;
}
function set2018Trades(range)
{
  var tab = document.getElementById("table2018");
  var newRow, newCell, newText, currentValue;
  var header = tab.createTHead();

  for (var i = 1; i < range.length; i++) {
    newRow = tab.insertRow();
    for (var j = 0; j < range[i].length; j++) {
        addCell(range[i][j], newCell, newRow);
    }
    let pandL = ((range[i][6]-range[i][7])*100).toFixed(2);
    let pandLText;
    if (pandL < 0) pandLText = "($"+pandL+")";
    else pandLText = "$"+pandL;
    let daysInTrade = calculateDaysInTrade(range[i][8], range[i][9]);
    addCell(pandLText, newCell, newRow);
    addCell(daysInTrade, newCell, newRow);

    let pandLDay = (parseInt(pandL)/parseInt(daysInTrade)).toFixed(2);
    let pandLDayText;
    if (pandL < 0) pandLDayText = "($"+pandLDay+")";
    else pandLDayText = "$"+pandLDay;
    addCell(pandLDayText, newCell, newRow);
  }

  var tr, th;
  newRow = header.insertRow();     
  for (var j = 0; j < range[0].length; j++) {
      tr = document.getElementById('table2018').tHead.children[0],
      th = document.createElement('th');
      currentValue = range[0][j];
      th.innerHTML = currentValue;
      tr.appendChild(th);
  }
  addHeader("table2018", "P/L");
  addHeader("table2018", "Days in Trade");
  addHeader("table2018", "P/L/Day");
  addHeader("table2018", "Max Loss");
}
function getTwoOptionMidPrice(optionList, shortStrike, longStrike)
{
    var i, longMidPrice, shortMidPrice;
    for (i = 0; i < optionList.length; i++)
    {
      if (optionList[i].strike == shortStrike)
      {
        console.log('short strike price: ' + shortStrike);
        console.log('bid price: ' + optionList[i].bid);
        console.log('ask price: ' + optionList[i].ask);
        shortMidPrice = (optionList[i].bid + optionList[i].ask)/2;
        console.log('short mid price: ' + shortMidPrice); 

      }
      if (optionList[i].strike == longStrike)
      {
        console.log('long strike price: ' + longStrike);
        console.log('bid price: ' + optionList[i].bid);
        console.log('ask price: ' + optionList[i].ask);
        longMidPrice = (optionList[i].bid + optionList[i].ask)/2;   
        console.log('long mid price: ' + longMidPrice); 
      }
    }
    console.log('twoOptionMidPrice: ' + (shortMidPrice - longMidPrice));
    return shortMidPrice - longMidPrice;
}
function getPutSpreadMidPrice(puts, shortStrike, longStrike)
{
  console.log('puts');
  return getTwoOptionMidPrice(puts, shortStrike, longStrike);
}
function getCallSpreadMidPrice(calls, shortStrike, longStrike)
{
  console.log('calls');
  return getTwoOptionMidPrice(calls, shortStrike, longStrike);
}
function getICSpreadMidPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2)
{
  return getPutSpreadMidPrice(puts, shortStrike, longStrike) + getCallSpreadMidPrice(calls, shortStrike2, longStrike2);
}
function getIBSpreadMidPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2)
{
  return getICSpreadMidPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2);
}
function spreadMidCalculator(parsed, spreadType, shortStrike, longStrike, shortStrike2, longStrike2)
{
  console.log(spreadType);

  var puts = parsed.optionChain.result[0].options[0].puts;
  var calls = parsed.optionChain.result[0].options[0].calls;
  var spreadMidPrice = 0;
  if (spreadType == "Put") spreadMidPrice = getPutSpreadMidPrice(puts, shortStrike, longStrike);
  else if (spreadType == "Call") spreadMidPrice = getCallSpreadMidPrice(calls, shortStrike, longStrike);
  else if (spreadType == "IC") spreadMidPrice = getICSpreadMidPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2);
  else if (spreadType == "IB") spreadMidPrice = getIBSpreadMidPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2);
  console.log('mid price: ' + spreadMidPrice);
  return spreadMidPrice;
}

function getTwoOptionLastPrice(optionList, shortStrike, longStrike)
{
    var i, longLastPrice, shortLastPrice;
    for (i = 0; i < optionList.length; i++)
    {
      if (optionList[i].strike == shortStrike)
        shortLastPrice = optionList[i].lastPrice;
      if (optionList[i].strike == longStrike)
        longLastPrice = optionList[i].lastPrice;   
    }
    return shortLastPrice - longLastPrice;
}
function getPutSpreadLastPrice(puts, shortStrike, longStrike)
{
  return getTwoOptionLastPrice(puts, shortStrike, longStrike);
}
function getCallSpreadLastPrice(calls, shortStrike, longStrike)
{
  return getTwoOptionLastPrice(calls, shortStrike, longStrike);
}
function getICSpreadLastPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2)
{
  return getPutSpreadLastPrice(puts, shortStrike, longStrike) + getCallSpreadLastPrice(calls, shortStrike2, longStrike2);
}
function getIBSpreadLastPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2)
{
  return getICSpreadLastPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2);
}
function spreadLastCalculator(parsed, spreadType, shortStrike, longStrike, shortStrike2, longStrike2)
{
  var puts = parsed.optionChain.result[0].options[0].puts;
  var calls = parsed.optionChain.result[0].options[0].calls;
  var spreadLastPrice = 0;
  if (spreadType == "Put") spreadLastPrice = getPutSpreadLastPrice(puts, shortStrike, longStrike);
  else if (spreadType == "Call") spreadLastPrice = getCallSpreadLastPrice(calls, shortStrike, longStrike);
  else if (spreadType == "IC") spreadLastPrice = getICSpreadLastPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2);
  else if (spreadType == "IB") spreadLastPrice = getIBSpreadLastPrice(puts, calls, shortStrike, longStrike, shortStrike2, longStrike2);
  return spreadLastPrice;
}

function convertDate(exDate)
{
  var split = exDate.split('/');
  exDate = new Date(Date.UTC(parseInt(split[2]), parseInt(split[0])-1, parseInt(split[1]), '0','0','0','0'));
  return exDate.valueOf()/1000;
}


function getSpreadPrice(ticker, spreadType, exDate, shortStrike, longStrike, shortStrike2, longStrike2)
{
  var returnArray = [-1,-1];
  var exDate = convertDate(exDate);
  var queryString = "https://cors.io/?https://query1.finance.yahoo.com/v7/finance/options/" + ticker+"?date="+exDate;
  
  
  var request = new XMLHttpRequest();
  request.open('GET', queryString, false);  // `false` makes the request synchronous
  request.send(null);
  
  if (request.status === 200) {
        var returnSpreadPrice = "hello";
  var parsed = JSON.parse(request.responseText);

  returnArray[0] = spreadLastCalculator(parsed, spreadType, shortStrike, longStrike, shortStrike2, longStrike2).toFixed(2);
  returnArray[1] = spreadMidCalculator(parsed, spreadType, shortStrike, longStrike, shortStrike2, longStrike2).toFixed(2);

  return returnArray;  
      
  }
  else
  {
     return returnArray;
  }
}
function maxDifference(shortStrike, longStrike, shortStrike2, longStrike2)
{
   let diff = Math.abs(shortStrike - longStrike);
   let diff2 = Math.abs(shortStrike2 - longStrike2);
   if(diff > diff2) return diff;
   return diff2;
}
function maxLoss(range, i)
{
  var spreadType = range[i][1];
  var exDate = range[i][2];
  var shortStrike = range[i][3];
  var longStrike = range[i][4];
  var shortStrike2 = range[i+1][3];
  var longStrike2 = range[i+1][4];
  var numberOfContracts = range[i][5];
  var creditPerContract = range[i][6];

  let maxDiff;
  if (spreadType === "Put" || spreadType === "Call") 
    maxDiff = Math.abs(shortStrike-longStrike);
  else if (spreadType === "IB" || spreadType === "IC")
    maxDiff = maxDifference(shortStrike, longStrike, shortStrike2, longStrike2);

  return "$" + ((maxDiff-creditPerContract) * numberOfContracts*100).toFixed(2);
}
function formatPandL(credit, midPrice)
{
  let pandLText = ((credit - midPrice)*100).toFixed(2);
  if (isNaN(pandLText)) pandLText = null;
  else if (pandLText < 0) pandLText = "<p id=\"negative\"> ($" + Math.abs(pandLText).toFixed(2) +") </p>";
  else pandLText = "<p id=\"positive\"> $"+pandLText +  " </p>";

  // else if (pandLText < 0) pandLText = "<span id = \"negative\"> ($" + Math.abs(pandLText).toFixed(2) +") </span>";
  // else pandLText = "<span id = \"positive\"> $"+pandLText +  " </span>";
  console.log(pandLText);
  return pandLText;
}
function getAsynchSpreadPrice(ticker, spreadType, exDate, shortStrike, longStrike, shortStrike2, longStrike2, credit, midCell, lastCell, pandLCell)
{
  let midPrice, lastPrice;
  var exDate = convertDate(exDate);
  var queryString = "https://cors.io/?https://query1.finance.yahoo.com/v7/finance/options/" + ticker+"?date="+exDate;
  let pandLText;
  var request = new XMLHttpRequest();
  request.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var parsed = JSON.parse(request.responseText);
      midPrice = spreadMidCalculator(parsed, spreadType, shortStrike, longStrike, shortStrike2, longStrike2).toFixed(2)
      lastCell.innerHTML = spreadLastCalculator(parsed, spreadType, shortStrike, longStrike, shortStrike2, longStrike2).toFixed(2);
      midCell.innerHTML = midPrice;
      pandLCell.innerHTML = formatPandL(credit, midPrice);
    }
    else {
      midCell.innerHTML = 'Not Responding';
      lastCell.innerHTML = 'Not Responding';
      pandLCell.innerHTML = 'N/A'
    }
  };
  request.open('GET', queryString, true);
  request.send();
}
</script>